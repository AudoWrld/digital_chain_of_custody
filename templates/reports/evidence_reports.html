{% extends 'base.html' %}
{% load static %}

{% block title %}Analysis Report - {{ evidence.description }} - ChainProof{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports/evidence_reports.css' %}?v={{ STATIC_VERSION }}" />
{% endblock %}

{% block content %}
<div class="evidence-reports-container">
    <div class="evidence-reports-header">
        <div class="evidence-reports-title">
            <h1>Analysis Report</h1>
            <p class="evidence-reports-subtitle">Evidence: {{ evidence.description|default:evidence.original_filename }}</p>
        </div>
        <div class="evidence-reports-actions">
            <a href="{% url 'evidence:view' evidence.id %}" class="dashboard-create-btn" >
                <i class='bx bx-arrow-back'></i> Back to Evidence
            </a>
            {% if user.role == 'analyst' %}
                {% if reports %}
                    {% with first_report=reports.0 %}
                    <a href="{% url 'reports:edit' first_report.id %}" class="dashboard-create-btn">
                        <i class='bx bx-edit'></i> Edit Report
                    </a>
                    {% endwith %}
                {% else %}
                    <a href="{% url 'reports:create_for_evidence' evidence.case.case_id evidence.id %}" class="dashboard-create-btn">
                        <i class='bx bx-plus'></i> Add Report
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if reports %}
        {% for report in reports %}
        <div class="evidence-report-card">
            <div class="evidence-report-header">
                <div class="evidence-report-title">
                    <i class='bx bx-file-alt'></i>
                    <h2>{{ report.title }}</h2>
                </div>
                <div class="evidence-report-meta">
                    <span class="evidence-report-status {{ report.status }}">
                        {% if report.status == 'draft' %}
                            <i class='bx bx-pencil'></i>
                        {% elif report.status == 'submitted' %}
                            <i class='bx bx-send'></i>
                        {% elif report.status == 'reviewed' %}
                            <i class='bx bx-check-circle'></i>
                        {% elif report.status == 'approved' %}
                            <i class='bx bx-award'></i>
                        {% endif %}
                        {{ report.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="evidence-report-body">
                {% if report.content %}
                <div class="evidence-report-section">
                    <div class="evidence-report-section-title">
                        <i class='bx bx-search-alt'></i>
                        Analysis
                    </div>
                    <div class="evidence-report-content">
                        {{ report.content|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {% if report.findings %}
                <div class="evidence-report-section">
                    <div class="evidence-report-section-title">
                        <i class='bx bx-error-circle'></i>
                        Findings
                    </div>
                    <div class="evidence-report-findings">
                        {{ report.findings|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {% if report.recommendations %}
                <div class="evidence-report-section">
                    <div class="evidence-report-section-title">
                        <i class='bx bx-lightbulb'></i>
                        Recommendations
                    </div>
                    <div class="evidence-report-recommendations">
                        {{ report.recommendations|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="evidence-report-footer">
                <div class="evidence-report-date">
                    <i class='bx bx-calendar'></i>
                    Created {{ report.created_at|date:"F d, Y g:i A" }}
                    {% if report.updated_at != report.created_at %}
                        | Updated {{ report.updated_at|date:"F d, Y g:i A" }}
                    {% endif %}
                </div>
                <div class="evidence-report-actions">
                    {% if user.role == 'analyst' and report.created_by == user %}
                        <a href="{% url 'reports:edit' report.id %}" class="cases-action-btn" style="background: #3b82f6; color: #fff;">
                            <i class='bx bx-edit'></i> Edit
                        </a>
                        {% if report.status == 'draft' %}
                        <a href="{% url 'reports:submit' report.id %}" class="cases-action-btn" style="background: #10b981; color: #fff;">
                            <i class='bx bx-send'></i> Submit
                        </a>
                        {% endif %}
                    {% endif %}
                    {% if report.status == 'submitted' and user.is_staff %}
                        <a href="{% url 'reports:review' report.id %}" class="cases-action-btn" style="background: #f59e0b; color: #fff;">
                            <i class='bx bx-check-double'></i> Review
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="evidence-reports-empty">
        <i class='bx bx-file-blank'></i>
        <h3>No Analysis Report</h3>
        <p>No analysis has been submitted for this evidence yet.</p>
        {% if user.role == 'analyst' %}
            <a href="{% url 'evidence:analyze' evidence.id  %}" class="dashboard-create-btn"> Add Report
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
