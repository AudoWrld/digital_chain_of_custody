{% extends 'base.html' %}
{% block title %}View Case{% endblock %}
{% load static %}
{% load case_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/cases/view_case.css' %}?v={{ STATIC_VERSION }}" />

<div class="view-case-container">
  <div class="view-case-header">
    <h1 class="view-case-title">{{ case.case_id }} - {{ title }}</h1>
    <div class="view-case-meta">
      <div class="view-case-meta-item">
        <span class="view-case-meta-label">Created By:</span>
        <span class="view-case-meta-value">{{ case.created_by.get_full_name }}</span>
      </div>
      <div class="view-case-meta-item">
        <span class="view-case-meta-label">Created At:</span>
        <span class="view-case-meta-value">{{ case.date_created|date:"F d, Y g:i A" }}</span>
      </div>
      <div class="view-case-meta-item">
        <span class="view-case-meta-label">Last Modified:</span>
        <span class="view-case-meta-value">{{ case.last_modified|date:"F d, Y g:i A" }}</span>
      </div>
    </div>
  </div>

  <div class="view-case-section">
    <h2 class="view-case-section-title">Case Details</h2>
    <div class="view-case-details-grid">
      <div class="view-case-detail-item">
        <span class="view-case-detail-label">Status</span>
        <span class="view-case-detail-value">
          {% if case.case_status == 'Open' %}
          <span class="view-case-status-badge view-case-status-open">{{ case.case_status }}</span>
          {% elif case.case_status == 'Pending Admin Approval' %}
          <span class="view-case-status-badge view-case-status-pending">{{ case.case_status }}</span>
          {% elif case.case_status == 'Approved & Assigned' %}
          <span class="view-case-status-badge view-case-status-approved">{{ case.case_status }}</span>
          {% elif case.case_status == 'Under Review' %}
          <span class="view-case-status-badge view-case-status-under">{{ case.case_status }}</span>
          {% elif case.case_status == 'Closed' %}
          <span class="view-case-status-badge view-case-status-closed">{{ case.case_status }}</span>
          {% elif case.case_status == 'Archived' %}
          <span class="view-case-status-badge view-case-status-archived">{{ case.case_status }}</span>
          {% elif case.case_status == 'Invalid' %}
          <span class="view-case-status-badge view-case-status-invalid">{{ case.case_status }}</span>
          {% elif case.case_status == 'Withdrawn' %}
          <span class="view-case-status-badge view-case-status-withdrawn">{{ case.case_status }}</span>
          {% else %}
          <span class="view-case-status-badge">{{ case.case_status }}</span>
          {% endif %}
        </span>
      </div>
      <div class="view-case-detail-item">
        <span class="view-case-detail-label">Priority</span>
        <span class="view-case-detail-value">
          {% if case.case_priority == 'low' %}
          <span class="view-case-priority-badge view-case-priority-low">{{ case.get_case_priority_display }}</span>
          {% elif case.case_priority == 'medium' %}
          <span class="view-case-priority-badge view-case-priority-medium">{{ case.get_case_priority_display }}</span>
          {% elif case.case_priority == 'high' %}
          <span class="view-case-priority-badge view-case-priority-high">{{ case.get_case_priority_display }}</span>
          {% elif case.case_priority == 'critical' %}
          <span class="view-case-priority-badge view-case-priority-critical">{{ case.get_case_priority_display }}</span>
          {% endif %}
        </span>
      </div>
      <div class="view-case-detail-item">
        <span class="view-case-detail-label">Category</span>
        <span class="view-case-detail-value">{{ case.get_category }}</span>
      </div>
      <div class="view-case-detail-item">
        <span class="view-case-detail-label">Assigned Investigators</span>
        <span class="view-case-detail-value">
          {% if case.assigned_investigators.all %}
          <div class="view-case-investigators-list">
            {% for inv in case.assigned_investigators.all %}
            <div class="view-case-investigator-item">
              <span class="view-case-investigator-tag">{{ inv.get_full_name }}</span>
              {% if inv.id in investigator_statuses %}
                {% with inv_status=investigator_statuses|get_item:inv.id %}
                {% if inv_status.accepted %}
                  <span class="view-case-investigator-status view-case-investigator-accepted">Accepted</span>
                {% else %}
                  <span class="view-case-investigator-status view-case-investigator-pending">Pending Acceptance</span>
                {% endif %}
                {% if inv_status.under_review %}
                  <span class="view-case-investigator-status view-case-investigator-review">Under Review</span>
                {% endif %}
                {% endwith %}
              {% else %}
                <span class="view-case-investigator-status view-case-investigator-pending">Pending Acceptance</span>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <span style="color: #94a3b8;">None assigned</span>
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="view-case-section">
    <h2 class="view-case-section-title">Description</h2>
    <div class="view-case-description">{{ case.get_description }}</div>
  </div>

  <div class="view-case-section">
    <h2 class="view-case-section-title">Evidence</h2>
    {% if media_files %}
    <div class="evidence-grid">
      {% for media in media_files %}
      <div class="evidence-card">
        <div class="evidence-card-header">
          <div class="evidence-type-badge">{{ media.get_media_type_display }}</div>
          <div class="evidence-status-badge {% if media.media_status == 'Valid' %}evidence-status-valid{% elif media.media_status == 'Invalid' %}evidence-status-invalid{% endif %}">
            {{ media.media_status }}
          </div>
        </div>
        <div class="evidence-card-body">
          <div class="evidence-description">{{ media.description }}</div>
          <div class="evidence-hash">
            <span class="evidence-hash-label">SHA-256:</span>
            <span class="evidence-hash-value">{{ media.sha256_hash }}</span>
          </div>
          {% if media.is_immutable %}
          <div class="evidence-immutable-badge">Immutable</div>
          {% endif %}
        </div>
        <div class="evidence-card-footer">
          <a href="{% url 'evidence:view' media.id %}" class="evidence-btn evidence-btn-primary">View</a>
          {% if user.is_staff %}
          <a href="{% url 'evidence:audit' media.id %}" class="evidence-btn evidence-btn-secondary">Audit Log</a>
          {% endif %}
          {% if user.role == 'analyst' and not media.has_analysis %}
          <a href="{% url 'evidence:analyze' media.id %}" class="evidence-btn evidence-btn-secondary">Analyze</a>
          {% endif %}
          {% if user.is_staff or user.role == 'analyst' %}
          <a href="{% url 'evidence:verify' media.id %}" class="evidence-btn evidence-btn-secondary">Verify Integrity</a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="view-case-empty-media">
      No evidence uploaded for this case.
    </div>
    {% endif %}
  </div>

  <div class="view-case-section">
    <h2 class="view-case-section-title">Actions</h2>
    <div class="view-case-actions">
      {% if is_superuser %}
        <a href="{% url 'cases:assign_investigators' case.case_id %}" class="view-case-action-btn view-case-action-primary">{% if investigators %}Update Investigators{% else %}Assign Investigators{% endif %}</a>
        <a href="{% url 'cases:view_case_audit_log' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Case Audit Log</a>
        <a href="{% url 'cases:case_list' %}" class="view-case-action-btn view-case-action-secondary">Back to Cases</a>
      {% elif user.role == 'regular_user' and not is_superuser %}
        {% if case.case_status == 'Open' %}
        <a href="{% url 'cases:edit_case' case.case_id %}" class="view-case-action-btn view-case-action-primary">Edit Case</a>
        {% else %}
        <span class="view-case-action-disabled">Case editing disabled - case has moved past Open status</span>
        {% endif %}
        {% if not case.closure_requested %}
        <a href="{% url 'cases:request_case_closure' case.case_id %}" class="view-case-action-btn view-case-action-warning">Request Closure</a>
        {% endif %}
        <a href="{% url 'cases:case_list' %}" class="view-case-action-btn view-case-action-secondary">Back to Cases</a>
      {% elif user.role == 'investigator' %}
        {% if not investigator_status or not investigator_status.accepted %}
        <a href="{% url 'cases:accept_case' case.case_id %}" class="view-case-action-btn view-case-action-primary">Accept Case</a>
        {% elif investigator_status.accepted and not investigator_status.under_review %}
        <a href="{% url 'cases:mark_under_review' case.case_id %}" class="view-case-action-btn view-case-action-primary">Mark as Under Review</a>
        {% elif investigator_status.under_review %}
        {% if case.case_status not in 'Closed,Archived,Withdrawn,Invalid' %}
        <a href="{% url 'evidence:upload' case.case_id %}" class="view-case-action-btn view-case-action-primary">Upload Evidence</a>
        {% endif %}
        {% if not case.closure_requested %}
        <a href="{% url 'cases:request_case_closure' case.case_id %}" class="view-case-action-btn view-case-action-warning">Request Closure</a>
        {% endif %}
        {% endif %}
        <a href="{% url 'cases:case_list' %}" class="view-case-action-btn view-case-action-secondary">Back to Cases</a>
      {% elif user.role in 'analyst,auditor' %}
        <a href="{% url 'auditor:auditor_case_audit_logs' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Case Audit Log</a>
        <a href="{% url 'cases:case_list' %}" class="view-case-action-btn view-case-action-secondary">Back to Cases</a>
      {% else %}
        {% if case.case_status not in 'Closed,Archived,Withdrawn,Invalid' %}
        <a href="{% url 'evidence:upload' case.case_id %}" class="view-case-action-btn view-case-action-primary">Upload Evidence</a>
        {% endif %}
        {% if case.case_status == 'Open' %}
        <a href="{% url 'cases:edit_case' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Edit Case</a>
        <a href="{% url 'cases:assign_investigators' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Assign Investigators</a>
        <a href="{% url 'cases:withdraw_case' case.case_id %}" class="view-case-action-btn view-case-action-danger">Withdraw Case</a>
        <a href="{% url 'cases:invalidate_case' case.case_id %}" class="view-case-action-btn view-case-action-danger">Mark Invalid</a>
        {% endif %}
        {% if case.case_status == 'Closed' %}
        <a href="{% url 'cases:archive_case' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Archive Case</a>
        {% endif %}
        <a href="{% url 'cases:view_case_audit_log' case.case_id %}" class="view-case-action-btn view-case-action-secondary">Case Audit Log</a>
        <a href="{% url 'cases:case_list' %}" class="view-case-action-btn view-case-action-secondary">Back to Cases</a>
      {% endif %}
    </div>
  </div>

  {% if case.case_status == 'Pending Admin Approval' and request.user.is_staff %}
  <div class="view-case-section">
    <h2 class="view-case-section-title">Pending Investigator Assignment</h2>
    {% for req in case.assignment_requests.all %}
      {% if req.status == 'pending_admin' %}
      <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
        <p style="margin-bottom: 8px;"><strong>Proposed by:</strong> {{ req.requested_by.get_full_name }}</p>
        <p style="margin-bottom: 8px;"><strong>Proposed Investigators:</strong> {% for u in req.assigned_users.all %}{{ u.get_full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
        <p style="margin-bottom: 12px;"><strong>Notes:</strong> {{ req.notes }}</p>
        <form method="post" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="approve">
          <input type="hidden" name="request_id" value="{{ req.id }}">
          <button type="submit" class="view-case-action-btn view-case-action-primary">Approve Assignment</button>
        </form>
        <form method="post" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="action" value="reject">
          <input type="hidden" name="request_id" value="{{ req.id }}">
          <button type="submit" class="view-case-action-btn view-case-action-danger">Reject Assignment</button>
        </form>
      </div>
      {% endif %}
    {% endfor %}
    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e2e8f0;">
    <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600; color: #1e293b;">Assign New Investigators</h3>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="assign_direct">
      <label for="direct_investigators" style="display: block; margin-bottom: 8px; font-weight: 500; color: #475569;">Select Investigators:</label>
      <select name="direct_investigators" id="direct_investigators" multiple style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 120px;">
        {% for user_obj in investigators %}
        <option value="{{ user_obj.id }}">{{ user_obj.get_full_name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="view-case-action-btn view-case-action-primary" style="margin-top: 12px;">Assign Directly</button>
    </form>
  </div>
  {% endif %}

  {% if case.closure_requested or case.case_status == 'Closed' %}
  <div class="view-case-section view-case-danger-zone">
    <h2 class="view-case-section-title">Case Closure</h2>
    {% if case.close_reason %}
    <div style="margin-bottom: 16px;">
      <span class="view-case-detail-label">Closure Reason:</span>
      <p style="margin-top: 8px; color: #475569; line-height: 1.6;">{{ case.close_reason }}</p>
    </div>
    {% endif %}
    {% if request.user.is_staff or request.user.is_superuser %}
      {% if case.case_status != 'Closed' %}
      <a href="{% url 'cases:admin_approve_case_closure' case.case_id %}" class="view-case-action-btn view-case-action-danger">Approve Closure</a>
      {% else %}
      <a href="{% url 'cases:reopen_case' case.case_id %}" class="view-case-action-btn view-case-action-success">Reopen Case</a>
      {% endif %}
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}