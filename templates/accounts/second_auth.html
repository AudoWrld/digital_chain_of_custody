{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Two‑Factor Authentication — Chain of Custody</title>
    <link rel="stylesheet" href="{% static 'css/accounts/second_auth.css' %}" />
  </head>
  <body>
    <nav class="brand-nav" role="navigation" aria-label="Main">
      <div class="brand-left">
        <img src="{% static 'images/logo.png' %}" alt="Chain of Custody logo" class="nav-logo" />
        <span class="brand-title">Chain of Custody</span>
      </div>
      <ul class="nav-right">
        <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li><a href="{% url 'logout' %}">Logout</a></li>
      </ul>
    </nav>

    <main class="auth-wrapper">
      <section class="auth-card" aria-labelledby="auth-heading">
        <h1 id="auth-heading">Two‑Factor Authentication</h1>

        {% if messages %}
          <ul class="messages" role="status" aria-live="polite">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if qr_code %}
          <p class="muted">Scan the QR code with your authenticator (Google Authenticator, Authy, etc.)</p>
          <div class="qr-row">
            <div class="qr-wrap" aria-hidden="false">
              <img src="data:image/png;base64,{{ qr_code }}" alt="Authenticator QR code" />
            </div>

            <div class="secret-col">
              <label class="label">Manual secret</label>
              <div class="secret-box">
                <code id="totp-secret">{{ secret }}</code>
                <button type="button" class="btn-ghost" id="copy-secret" data-secret="{{ secret }}">Copy</button>
              </div>

              <p class="muted small">If your authenticator cannot scan QR codes, enter the secret above.</p>
            </div>
          </div>
        {% endif %}

        <form method="post" class="verify-form" novalidate>
          {% csrf_token %}
          <label for="token" class="label">Enter 6‑digit code</label>
          <input id="token" name="token" inputmode="numeric" pattern="\d{6}" maxlength="16" placeholder="123456" required />

          <button type="submit" class="btn-primary">Verify</button>
        </form>

        {% if user.two_factor_enabled %}
          <p class="muted small" style="margin-top:12px;">
            Lost access to your authenticator app?
            <a href="{% url 'verify_recovery_code' %}" class="link">Verify using a recovery code</a>
          </p>
        {% endif %}
      </section>
    </main>

    <script>
      document.addEventListener('click', function (e) {
        if (!e.target.matches('#copy-secret')) return;
        const secret = e.target.getAttribute('data-secret') || document.getElementById('totp-secret')?.textContent;
        if (!secret) return;
        navigator.clipboard?.writeText(secret).then(() => {
          const btn = e.target;
          const old = btn.textContent;
          btn.textContent = 'Copied';
          setTimeout(() => (btn.textContent = old), 1200);
        }).catch(() => {
          alert('Copy failed — select and copy manually.');
        });
      });
    </script>
  </body>
</html>
// ...existing code...