{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Two-Factor Authentication</title>
    <link rel="stylesheet" href="{% static 'css/accounts/second_auth.css' %}?v={{ STATIC_VERSION }}" />
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(toast => {
          setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => {
              toast.remove();
            }, 300);
          }, 5000);
        });
      });
    </script>
  </head>
  <body>
    {% if messages %}
      <div class="toast-container">
        {% for message in messages %}
          <div class="toast {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="login-wrapper">
      <div class="login-card">
        <div class="login-brand">
          <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo" />
          <div class="title">Chain of Custody</div>
        </div>

        <h2>Two-Factor Authentication</h2>

        {% if qr_code %}
          <p class="muted">Scan the QR code with your authenticator (Google Authenticator, Authy, etc.)</p>
          <div class="qr-row">
            <div class="qr-wrap" aria-hidden="false">
              <img src="data:image/png;base64,{{ qr_code }}" alt="Authenticator QR code" />
            </div>

            <div class="secret-col">
              <label class="label">Manual secret</label>
              <div class="secret-box">
                <code id="totp-secret">{{ secret }}</code>
                <button type="button" class="btn-ghost" id="copy-secret" data-secret="{{ secret }}">Copy</button>
              </div>

              <p class="muted small">If your authenticator cannot scan QR codes, enter the secret above.</p>
            </div>
          </div>
        {% endif %}

        <form method="post" novalidate>
          {% csrf_token %}
          <label for="token">Enter 6-digit code</label>
          <input type="text" id="token" name="token" inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="123456" required />

          <button type="submit">Verify</button>
        </form>

        {% if user.two_factor_enabled %}
          <p class="muted small" style="margin-top:12px;">
            Lost access to your authenticator app?
            <a href="{% url 'verify_recovery_code' %}" class="link">Verify using a recovery code</a>
          </p>
        {% endif %}
      </div>
    </div>

    <script>
      document.addEventListener('click', function (e) {
        if (!e.target.matches('#copy-secret')) return;
        const secret = e.target.getAttribute('data-secret') || document.getElementById('totp-secret')?.textContent;
        if (!secret) return;
        navigator.clipboard?.writeText(secret).then(() => {
          const btn = e.target;
          const old = btn.textContent;
          btn.textContent = 'Copied';
          setTimeout(() => (btn.textContent = old), 1200);
        }).catch(() => {
          alert('Copy failed â€” select and copy manually.');
        });
      });

      document.addEventListener('DOMContentLoaded', function() {
        const tokenInput = document.getElementById('token');
        
        if (tokenInput) {
          // Prevent non-numeric input
          tokenInput.addEventListener('input', function(e) {
            // Remove any non-numeric characters
            this.value = this.value.replace(/[^0-9]/g, '');
          });
          
          // Prevent non-numeric keypresses
          tokenInput.addEventListener('keypress', function(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Command+A
                (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                // Allow: home, end, left, right, down, up
                (e.keyCode >= 35 && e.keyCode <= 40)) {
              return;
            }
            
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
              e.preventDefault();
            }
          });
          
          // Prevent paste of non-numeric content
          tokenInput.addEventListener('paste', function(e) {
            const pastedData = (e.clipboardData || window.clipboardData).getData('text');
            const numericData = pastedData.replace(/[^0-9]/g, '');
            
            if (pastedData !== numericData) {
              e.preventDefault();
              // Only paste the numeric characters
              document.execCommand('insertText', false, numericData);
            }
          });
        }
      });
    </script>
  </body>
</html>
