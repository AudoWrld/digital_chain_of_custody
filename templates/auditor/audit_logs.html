{% extends 'base.html' %}
{% block title %}Audit Logs - ChainProof{% endblock %}
{% load static %}
{% load case_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/cases/case_list.css' %}?v={{ STATIC_VERSION }}" />

<div class="cases-page-header">
  <div class="cases-page-title">
    <h1>Audit Logs</h1>
  </div>
  <div class="cases-page-actions">
    <div class="filter-tabs">
      <a href="?type=all" class="tab {% if log_source == 'all' %}active{% endif %}">All</a>
      <a href="?type=case" class="tab {% if log_source == 'case' %}active{% endif %}">Case Logs</a>
      <a href="?type=evidence" class="tab {% if log_source == 'evidence' %}active{% endif %}">Evidence Logs</a>
      <a href="?type=custody" class="tab {% if log_source == 'custody' %}active{% endif %}">Custody Logs</a>
    </div>
  </div>
</div>

{% if case_audit_logs or evidence_audit_logs or custody_logs %}
<div class="cases-table-wrapper">
  {% if log_source == 'all' or log_source == 'case' %}
  {% if case_audit_logs %}
  <h2 class="section-title"><i class='bx bx-briefcase'></i> Case Audit Logs</h2>
  <table class="cases-data-table">
    <thead class="cases-table-head">
      <tr>
        <th class="cases-table-header">Timestamp</th>
        <th class="cases-table-header">Case</th>
        <th class="cases-table-header">User</th>
        <th class="cases-table-header">Action</th>
        <th class="cases-table-header">Details</th>
      </tr>
    </thead>
    <tbody class="cases-table-body">
      {% for log in case_audit_logs %}
      <tr class="cases-table-row">
        <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
        <td class="cases-table-cell">
          {% if log.case %}
          <a href="{% url 'auditor:auditor_case_audit_logs' log.case.case_id %}">{{ log.case.case_id }}</a>
          {% else %}-{% endif %}
        </td>
        <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
        <td class="cases-table-cell">{{ log.action }}</td>
        <td class="cases-table-cell">{{ log.details|truncatechars:50 }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% endif %}

  {% if log_source == 'all' or log_source == 'evidence' %}
  {% if evidence_audit_logs %}
  <h2 class="section-title"><i class='bx bx-archive'></i> Evidence Audit Logs</h2>
  <table class="cases-data-table">
    <thead class="cases-table-head">
      <tr>
        <th class="cases-table-header">Timestamp</th>
        <th class="cases-table-header">Evidence ID</th>
        <th class="cases-table-header">Case</th>
        <th class="cases-table-header">User</th>
        <th class="cases-table-header">Action</th>
        <th class="cases-table-header">Details</th>
      </tr>
    </thead>
    <tbody class="cases-table-body">
      {% for log in evidence_audit_logs %}
      <tr class="cases-table-row">
        <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
        <td class="cases-table-cell">
          <a href="{% url 'auditor:evidence_custody_history' log.evidence.id %}">{{ log.evidence.id }}</a>
        </td>
        <td class="cases-table-cell">{{ log.evidence.case.case_id }}</td>
        <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
        <td class="cases-table-cell">{{ log.action }}</td>
        <td class="cases-table-cell">{{ log.details|truncatechars:50 }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% endif %}

  {% if log_source == 'all' or log_source == 'custody' %}
  {% if custody_logs %}
  <h2 class="section-title"><i class='bx bx-transfer'></i> Custody Logs</h2>
  <table class="cases-data-table">
    <thead class="cases-table-head">
      <tr>
        <th class="cases-table-header">Timestamp</th>
        <th class="cases-table-header">Evidence ID</th>
        <th class="cases-table-header">Case</th>
        <th class="cases-table-header">User</th>
        <th class="cases-table-header">Action</th>
        <th class="cases-table-header">Location</th>
      </tr>
    </thead>
    <tbody class="cases-table-body">
      {% for log in custody_logs %}
      <tr class="cases-table-row">
        <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
        <td class="cases-table-cell">
          <a href="{% url 'auditor:evidence_custody_history' log.evidence.id %}">{{ log.evidence.id }}</a>
        </td>
        <td class="cases-table-cell">{{ log.case.case_id }}</td>
        <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
        <td class="cases-table-cell">{{ log.action }}</td>
        <td class="cases-table-cell">{{ log.to_location.name|default:"-" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% endif %}
</div>
{% else %}
<div class="cases-empty-state">
  <p>No audit logs found.</p>
</div>
{% endif %}
{% endblock %}
