{% extends "base.html" %}
{% load static %}
{% load case_extras %}

{% block title %}Integrity Report - {{ case.case_id }} - ChainProof{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/evidence/verify_evidence.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Integrity Report: {{ case.case_id }}</h1>
    <div class="header-actions">
        <a href="{% url 'auditor:auditor_case_audit_logs' case.case_id %}" class="btn btn-secondary">
            <i class='bx bx-arrow-back'></i> Back to Audit Logs
        </a>
        <a href="{% url 'auditor:integrity_check' %}" class="btn btn-primary">
            <i class='bx bx-check-shield'></i> All Integrity Reports
        </a>
    </div>
</div>

<div class="case-info-card">
    <div class="info-row">
        <span class="info-label">Case Title:</span>
        <span class="info-value">{{ case.title }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Status:</span>
        <span class="badge badge-{{ case.case_status|slugify_status }}">{{ case.case_status }}</span>
    </div>
    <div class="info-row">
        <span class="info-label">Created By:</span>
        <span class="info-value">{{ case.created_by.get_full_name|default:case.created_by.username }}</span>
    </div>
</div>

<div class="stats-row">
    <div class="stat-card">
        <div class="stat-value">{{ total_evidence }}</div>
        <div class="stat-label">Total Evidence</div>
    </div>
    <div class="stat-card success">
        <div class="stat-value">{{ valid_count }}</div>
        <div class="stat-label">Valid Integrity</div>
    </div>
    <div class="stat-card danger">
        <div class="stat-value">{{ invalid_count }}</div>
        <div class="stat-label">Integrity Issues</div>
    </div>
</div>

<div class="integrity-list">
    {% for evidence in evidence_list %}
    <div class="integrity-card {% if not evidence.metadata_valid %}has-issues{% endif %}">
        <div class="integrity-header">
            <div class="evidence-id">#{{ evidence.id }}</div>
            <div class="integrity-status">
                {% if evidence.metadata_valid %}
                <span class="status-valid"><i class='bx bx-check-circle'></i> Valid</span>
                {% else %}
                <span class="status-invalid"><i class='bx bx-error-circle'></i> Issues Found</span>
                {% endif %}
            </div>
        </div>
        
        <div class="integrity-body">
            <div class="evidence-info">
                <h3>{{ evidence.description|truncatechars:100 }}</h3>
                <p class="file-info">{{ evidence.original_filename }} ({{ evidence.media_type }})</p>
            </div>
            
            <div class="hash-info">
                <div class="hash-row">
                    <span class="hash-label">SHA256:</span>
                    <span class="hash-value" title="{{ evidence.sha256_hash }}">{{ evidence.sha256_hash }}</span>
                </div>
            </div>
            
            {% if evidence.metadata_issues %}
            <div class="issues-list">
                <h4><i class='bx bx-error'></i> Metadata Issues:</h4>
                <ul>
                    {% for issue in evidence.metadata_issues %}
                    <li>{{ issue }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        
        <div class="integrity-footer">
            <a href="{% url 'auditor:evidence_custody_history' evidence.id %}" class="btn btn-sm">
                <i class='bx bx-history'></i> View History
            </a>
            <span class="upload-date">Uploaded {{ evidence.date_uploaded|date:"M d, Y H:i" }}</span>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <i class='bx bx-archive'></i>
        <p>No evidence found in this case.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}
