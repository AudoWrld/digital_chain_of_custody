{% extends 'base.html' %}
{% block title %}Custody History - Evidence #{{ evidence.id }} - ChainProof{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auditor/integrity_check.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<div class="integrity-page-header">
    <div class="integrity-page-title">
        <h1>Custody History: Evidence #{{ evidence.id }}</h1>
    </div>
    <div class="integrity-page-actions">
        <a href="{% url 'auditor:chain_of_custody' %}" class="integrity-btn integrity-btn-secondary">
            <i class='bx bx-arrow-back'></i> Back to Chain of Custody
        </a>
        <a href="{% url 'auditor:integrity_check' %}" class="integrity-btn">
            <i class='bx bx-check-shield'></i> Integrity Check
        </a>
    </div>
</div>

<div class="integrity-evidence-section">
    <div class="integrity-section-header">
        <i class='bx bx-file'></i>
        <h2 class="integrity-section-title">Evidence Information</h2>
    </div>
    <div class="integrity-evidence-list">
        <div class="integrity-evidence-card">
            <div class="integrity-evidence-header">
                <span class="integrity-evidence-id">#{{ evidence.id }}</span>
                <span class="integrity-status-badge {% if evidence.metadata_valid %}integrity-status-valid{% else %}integrity-status-issues{% endif %}">
                    {% if evidence.metadata_valid %}
                    <i class='bx bx-check'></i> Valid
                    {% else %}
                    <i class='bx bx-x'></i> Invalid
                    {% endif %}
                </span>
            </div>
            
            <div class="integrity-evidence-meta">
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Case</span>
                    <span class="integrity-meta-value">
                        <a href="{% url 'auditor:auditor_case_audit_logs' evidence.case.case_id %}">{{ evidence.case.case_id }}</a>
                    </span>
                </div>
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Description</span>
                    <span class="integrity-meta-value">{{ evidence.description }}</span>
                </div>
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Original Filename</span>
                    <span class="integrity-meta-value">{{ evidence.original_filename }}</span>
                </div>
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Media Type</span>
                    <span class="integrity-meta-value">{{ evidence.media_type }}</span>
                </div>
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Uploaded By</span>
                    <span class="integrity-meta-value">{{ evidence.uploaded_by.get_full_name|default:evidence.uploaded_by.username }}</span>
                </div>
                <div class="integrity-meta-item">
                    <span class="integrity-meta-label">Upload Date</span>
                    <span class="integrity-meta-value">{{ evidence.date_uploaded|date:"M d, Y H:i:s" }}</span>
                </div>
            </div>
            
            <div class="integrity-hash-display">
                <span class="integrity-hash-label">SHA256:</span>{{ evidence.sha256_hash }}
            </div>
            <div class="integrity-hash-display">
                <span class="integrity-hash-label">MD5:</span>{{ evidence.md5_hash }}
            </div>
            
            {% if evidence.metadata_issues %}
            <div class="integrity-issues-display">
                <div class="integrity-issues-title">
                    <i class='bx bx-error'></i> Metadata Issues
                </div>
                <ul class="integrity-issues-list">
                    {% for issue in evidence.metadata_issues %}
                    <li>{{ issue }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if custody_logs %}
<div class="integrity-evidence-section">
    <div class="integrity-section-header">
        <i class='bx bx-transfer'></i>
        <h2 class="integrity-section-title">Custody Transfer History</h2>
        <span class="integrity-section-count">{{ custody_logs|length }} entries</span>
    </div>
    <div class="integrity-evidence-list">
        <table class="coc-table" style="margin: 0;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>From Location</th>
                    <th>To Location</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for log in custody_logs %}
                <tr>
                    <td>{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
                    <td>{{ log.user.get_full_name|default:log.user.username }}</td>
                    <td>{{ log.action }}</td>
                    <td>{{ log.from_location.name|default:"-" }}</td>
                    <td>{{ log.to_location.name|default:"-" }}</td>
                    <td>{{ log.details|truncatechars:50 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if audit_logs %}
<div class="integrity-evidence-section">
    <div class="integrity-section-header">
        <i class='bx bx-history'></i>
        <h2 class="integrity-section-title">Audit Log</h2>
        <span class="integrity-section-count">{{ audit_logs|length }} entries</span>
    </div>
    <div class="integrity-evidence-list">
        <table class="coc-table" style="margin: 0;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audit_logs %}
                <tr>
                    <td>{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
                    <td>{{ log.user.get_full_name|default:log.user.username }}</td>
                    <td>{{ log.action }}</td>
                    <td>{{ log.details|truncatechars:80 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if not custody_logs and not audit_logs %}
<div class="integrity-empty-state">
    <i class='bx bx-history'></i>
    <p>No logs found for this evidence.</p>
</div>
{% endif %}
{% endblock %}
