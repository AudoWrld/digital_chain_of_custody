{% extends 'base.html' %}
{% block title %}Audit Logs - {{ case.case_id }} - ChainProof{% endblock %}
{% load static %}
{% load case_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/cases/case_list.css' %}?v={{ STATIC_VERSION }}" />
<style>
  .audit-section {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 24px;
    overflow: hidden;
  }

  .audit-section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: #f8fafc;
    border-bottom: 2px solid #e2e8f0;
  }

  .audit-section-header i {
    font-size: 20px;
    color: #3b82f6;
  }

  .audit-section-title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
  }

  .audit-section-count {
    margin-left: auto;
    background: #e2e8f0;
    color: #475569;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .audit-table-wrapper {
    overflow-x: auto;
  }

  .case-info-section {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 24px;
  }

  .case-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .case-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .case-info-label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .case-info-value {
    font-size: 15px;
    color: #1e293b;
    font-weight: 500;
  }
</style>

<div class="cases-page-header">
  <div class="cases-page-title">
    <h1>Audit Logs: {{ case.case_id }}</h1>
  </div>
  <div class="cases-page-actions">
    <a href="{% url 'auditor:dashboard' %}" class="cases-create-btn" style="background: #64748b;">
      <i class='bx bx-arrow-back'></i> Back to Dashboard
    </a>
  </div>
</div>

<div class="case-info-section">
  <div class="case-info-grid">
    <div class="case-info-item">
      <span class="case-info-label">Case Title</span>
      <span class="case-info-value">{{ case.get_title }}</span>
    </div>
    <div class="case-info-item">
      <span class="case-info-label">Status</span>
      <span class="case-info-value">
        <span class="cases-status-badge cases-status-{{ case.case_status|slugify_status }}">{{ case.case_status }}</span>
      </span>
    </div>
    <div class="case-info-item">
      <span class="case-info-label">Created By</span>
      <span class="case-info-value">{{ case.created_by.get_full_name|default:case.created_by.username }}</span>
    </div>
    <div class="case-info-item">
      <span class="case-info-label">Date Created</span>
      <span class="case-info-value">{{ case.date_created|date:"M d, Y" }}</span>
    </div>
  </div>
</div>

{% if case_logs %}
<div class="audit-section">
  <div class="audit-section-header">
    <i class='bx bx-briefcase'></i>
    <h2 class="audit-section-title">Case Audit Trail</h2>
    <span class="audit-section-count">{{ case_logs|length }} entries</span>
  </div>
  <div class="audit-table-wrapper">
    <table class="cases-data-table">
      <thead class="cases-table-head">
        <tr>
          <th class="cases-table-header">Timestamp</th>
          <th class="cases-table-header">User</th>
          <th class="cases-table-header">Action</th>
          <th class="cases-table-header">Details</th>
        </tr>
      </thead>
      <tbody class="cases-table-body">
        {% for log in case_logs %}
        <tr class="cases-table-row">
          <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
          <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
          <td class="cases-table-cell">{{ log.action }}</td>
          <td class="cases-table-cell">{{ log.details|truncatechars:80 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if evidence_audit_logs %}
<div class="audit-section">
  <div class="audit-section-header">
    <i class='bx bx-archive'></i>
    <h2 class="audit-section-title">Evidence Audit Trail</h2>
    <span class="audit-section-count">{{ evidence_audit_logs|length }} entries</span>
  </div>
  <div class="audit-table-wrapper">
    <table class="cases-data-table">
      <thead class="cases-table-head">
        <tr>
          <th class="cases-table-header">Timestamp</th>
          <th class="cases-table-header">Evidence ID</th>
          <th class="cases-table-header">User</th>
          <th class="cases-table-header">Action</th>
          <th class="cases-table-header">Details</th>
        </tr>
      </thead>
      <tbody class="cases-table-body">
        {% for log in evidence_audit_logs %}
        <tr class="cases-table-row">
          <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
          <td class="cases-table-cell">
            <a href="{% url 'auditor:evidence_custody_history' log.evidence.id %}">{{ log.evidence.id }}</a>
          </td>
          <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
          <td class="cases-table-cell">{{ log.action }}</td>
          <td class="cases-table-cell">{{ log.details|truncatechars:80 }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if custody_logs %}
<div class="audit-section">
  <div class="audit-section-header">
    <i class='bx bx-transfer'></i>
    <h2 class="audit-section-title">Custody Transfer History</h2>
    <span class="audit-section-count">{{ custody_logs|length }} entries</span>
  </div>
  <div class="audit-table-wrapper">
    <table class="cases-data-table">
      <thead class="cases-table-head">
        <tr>
          <th class="cases-table-header">Timestamp</th>
          <th class="cases-table-header">Evidence</th>
          <th class="cases-table-header">User</th>
          <th class="cases-table-header">Action</th>
          <th class="cases-table-header">From Location</th>
          <th class="cases-table-header">To Location</th>
        </tr>
      </thead>
      <tbody class="cases-table-body">
        {% for log in custody_logs %}
        <tr class="cases-table-row">
          <td class="cases-table-cell">{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
          <td class="cases-table-cell">
            <a href="{% url 'auditor:evidence_custody_history' log.evidence.id %}">{{ log.evidence.id }}</a>
          </td>
          <td class="cases-table-cell">{{ log.user.get_full_name|default:log.user.username }}</td>
          <td class="cases-table-cell">{{ log.action }}</td>
          <td class="cases-table-cell">{{ log.from_location.name|default:"-" }}</td>
          <td class="cases-table-cell">{{ log.to_location.name|default:"-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if not case_logs and not evidence_audit_logs and not custody_logs %}
<div class="cases-empty-state">
  <p>No audit logs found for this case.</p>
</div>
{% endif %}
{% endblock %}
